# ==========================================================================
# NetTap CI Pipeline â€” Lint, Test, Build
# ==========================================================================
# Runs on every push to develop and on all pull requests.
# Validates shell scripts, Python daemon, SvelteKit web app, and Docker builds.

name: CI

on:
  push:
    branches: [develop]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ========================================================================
  # Shell Script Linting
  # ========================================================================
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck on all scripts
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: scripts/
          severity: warning

  # ========================================================================
  # Python Linting (ruff)
  # ========================================================================
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install ruff
        run: pip install ruff

      - name: Ruff check (lint)
        run: ruff check daemon/

      - name: Ruff format check
        run: ruff format --check daemon/

  # ========================================================================
  # SvelteKit Type Checking
  # ========================================================================
  lint-web:
    name: Lint Web (svelte-check)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: web/

      - name: Run svelte-check
        run: npx svelte-check --tsconfig ./tsconfig.json
        working-directory: web/

  # ========================================================================
  # Python Tests
  # ========================================================================
  test-daemon:
    name: Test Daemon (Python)
    runs-on: ubuntu-latest
    needs: lint-python
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: daemon/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r daemon/requirements.txt
          pip install pytest pytest-asyncio pytest-cov aioresponses

      - name: Run pytest
        run: python3 -m pytest daemon/tests/ -v --tb=short

  # ========================================================================
  # Web Tests
  # ========================================================================
  test-web:
    name: Test Web (Vitest)
    runs-on: ubuntu-latest
    needs: lint-web
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: web/

      - name: Run vitest
        run: npx vitest run
        working-directory: web/

  # ========================================================================
  # Docker Image Builds (verify they build, do not push)
  # ========================================================================
  docker-build:
    name: Docker Build (${{ matrix.image }})
    runs-on: ubuntu-latest
    needs: [test-daemon, test-web]
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: daemon
            dockerfile: docker/Dockerfile.daemon
          - image: web
            dockerfile: docker/Dockerfile.web
          - image: tshark
            dockerfile: docker/Dockerfile.tshark
          - image: cyberchef
            dockerfile: docker/Dockerfile.cyberchef
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.image }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: false
          tags: nettap/${{ matrix.image }}:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max
