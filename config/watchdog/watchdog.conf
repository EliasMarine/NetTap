# ==========================================================================
# NetTap Watchdog Configuration
# Template: config/watchdog/watchdog.conf
# Deployed to /etc/watchdog.conf by scripts/install/setup-watchdog.sh
# ==========================================================================
#
# The hardware watchdog timer is a last-resort failsafe for the NetTap
# appliance.  If the system hangs (kernel panic, OOM, runaway process),
# the watchdog hardware triggers a hard reboot, restoring network traffic
# flow within approximately 90 seconds.
#
# How it works:
#   1. The watchdog daemon writes to /dev/watchdog every 10 seconds ("pet")
#   2. The hardware watchdog chip maintains a countdown timer
#   3. Each pet resets the countdown to the configured timeout (60s)
#   4. If no pet arrives before the countdown expires, the hardware
#      triggers a power-cycle reboot
#
# On Intel N100 mini PCs (the target NetTap hardware), the watchdog is
# typically provided by the iTCO (Intel TCO) timer built into the chipset.
#
# ==========================================================================

# --- Hardware Watchdog Device ---
# Path to the watchdog device node.  /dev/watchdog is the standard Linux
# watchdog character device.  The kernel maps this to whichever watchdog
# driver is loaded (iTCO_wdt, softdog, etc.).
watchdog-device = /dev/watchdog

# --- Timing ---
# How often the daemon pets the watchdog (seconds).
# Lower values = more responsive but slightly more CPU overhead.
# 10 seconds is a good balance — gives 5 pets per timeout window.
interval = 10

# Hardware watchdog timeout (seconds).
# If the daemon fails to pet the watchdog within this period, the
# hardware triggers a reboot.  Not all hardware supports 60s — the
# daemon will negotiate the closest supported value.
#
# Common hardware limits:
#   - Intel iTCO: max 613s (supports 60s easily)
#   - softdog:    configurable, default 60s
#
# With interval=10 and timeout=60, the system tolerates up to 5 missed
# pets before rebooting.  This avoids false reboots from brief CPU spikes.
watchdog-timeout = 60

# --- System Health Checks ---
# These optional checks allow the watchdog daemon to trigger a reboot
# based on system health metrics, even if the daemon itself is healthy.

# Maximum 1-minute load average before triggering reboot.
# On a 4-core Intel N100, normal load under traffic is 2-8.
# Setting this to 24 (6x core count) means it only triggers on extreme
# runaway conditions (fork bombs, infinite loops).
# Set to 0 to disable this check.
max-load-1 = 24

# Minimum free memory (pages) before triggering reboot.
# 1 page = ~4KB.  This is an extreme safety net — the Linux OOM killer
# should handle most memory exhaustion before this triggers.
# Set to 0 to disable this check.
min-memory = 1

# Ping this address to verify the network stack is alive.
# We ping localhost (loopback) to check that the kernel's network
# subsystem is functional.  If the kernel network stack is dead,
# the bridge cannot forward traffic either.
#
# Note: We do NOT ping the gateway or external hosts because:
#   - The bridge interfaces have no IP addresses
#   - External connectivity issues should not trigger a reboot
#   - Localhost ping tests the kernel network stack, which is what matters
ping = 127.0.0.1

# Uncomment to also test a file write (verifies filesystem is responsive):
#file = /var/log/watchdog/test

# Uncomment to ping the default gateway (if management interface has one):
#ping = <gateway-ip>

# --- Logging ---
# Directory for watchdog event logs.  The daemon logs pet failures,
# health check violations, and reboot triggers here.
log-dir = /var/log/watchdog

# --- Realtime Scheduling ---
# Run the watchdog daemon with realtime scheduling priority.
# This ensures the pet writes happen on time even under extreme system
# load (which is exactly when the watchdog is most needed).
realtime = yes
priority = 1

# --- Repair Script (optional) ---
# Run this script before triggering a reboot.  Can be used to:
#   - Flush logs to disk
#   - Send a notification
#   - Attempt graceful container shutdown
#
# The repair script has repair-timeout seconds to complete before
# the reboot proceeds regardless.
#
#repair-binary = /usr/local/bin/nettap-watchdog-repair.sh
#repair-timeout = 30

# --- Temperature Monitoring (optional) ---
# On systems with hwmon temperature sensors, the watchdog can trigger
# a reboot if CPU temperature exceeds a threshold.  Uncomment and
# adjust for your hardware:
#
#temperature-sensor = /sys/class/hwmon/hwmon0/temp1_input
#max-temperature = 95

# --- Test Mode ---
# Uncomment to test the watchdog configuration without actually rebooting.
# The daemon will log what it would do instead of triggering a reboot.
# NEVER leave this enabled in production.
#
#test-mode = yes
