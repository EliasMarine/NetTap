; NetTap override of Malcolm's logstash supervisord config.
;
; Why: Malcolm's entrypoint uses `su` (heredoc) for privilege drop, but after
; setuid, /proc/self/fd/1 becomes inaccessible to the new user (kernel procfs
; restriction: l-wx------ root root). Supervisord's stdout_logfile=/dev/fd/1
; then fails with EACCES.
;
; Fix: Skip the entrypoint's su (PUSER_PRIV_DROP=false) so supervisord runs
; as root and CAN open /dev/fd/1. Add user=logstash so supervisord drops
; privileges when spawning the logstash process â€” logstash runs as non-root.
;
; Because PUSER_PRIV_DROP=false also skips the entrypoint's chown of data
; directories, fix-perms runs first (as root) to ensure the logstash user
; can write to the persistent queue volume.
;
; Original: ghcr.io/idaholab/malcolm/logstash-oss /etc/supervisord.conf
; Copyright (c) 2026 Battelle Energy Alliance, LLC.  All rights reserved.

[inet_http_server]
port=0.0.0.0:9001

[supervisord]
nodaemon=true
loglevel=error
logfile=/dev/null
logfile_maxbytes=0
pidfile=/tmp/supervisord.pid
environment=PATH=/usr/share/logstash/bin:%(ENV_PATH)s

[rpcinterface:supervisor]
supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=http://127.0.0.1:9001

; Fix data directory ownership and inject JVM options before logstash starts.
; Runs as root (no user= directive) since supervisord is root.
; Priority 1 ensures this completes before logstash (priority 999).
;
; JVM injection: Logstash does NOT support jvm.options.d/ drop-in directories
; (that is an Elasticsearch-only feature). The only way to set -Xss is to
; append it to the actual jvm.options file. The grep guard makes this idempotent.
; Malcolm's zeek pipeline (~75 configs) causes StackOverflowError at -Xss1m default.
[program:fix-perms]
command=sh -c "chown -R logstash:logstash /usr/share/logstash/data && grep -q '^-Xss' /usr/share/logstash/config/jvm.options || echo '-Xss8m' >> /usr/share/logstash/config/jvm.options"
autostart=true
autorestart=false
startsecs=0
priority=1
exitcodes=0
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

[program:logstash]
command=/usr/local/bin/logstash-start.sh
user=logstash
autostart=true
autorestart=true
startsecs=0
startretries=0
stopwaitsecs=60
stopasgroup=true
killasgroup=true
stopsignal=INT
priority=999
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true
