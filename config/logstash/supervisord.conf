; NetTap override of Malcolm's logstash supervisord config.
;
; Why: Malcolm's entrypoint uses `su` (heredoc) for privilege drop, but after
; setuid, /proc/self/fd/1 becomes inaccessible to the new user (kernel procfs
; restriction: l-wx------ root root). Supervisord's stdout_logfile=/dev/fd/1
; then fails with EACCES.
;
; Fix: Skip the entrypoint's su (PUSER_PRIV_DROP=false) so supervisord runs
; as root and CAN open /dev/fd/1. Add user=logstash so supervisord drops
; privileges when spawning the logstash process â€” logstash runs as non-root.
;
; Original: ghcr.io/idaholab/malcolm/logstash-oss /etc/supervisord.conf
; Copyright (c) 2026 Battelle Energy Alliance, LLC.  All rights reserved.

[inet_http_server]
port=0.0.0.0:9001

[supervisord]
nodaemon=true
loglevel=error
logfile=/dev/null
logfile_maxbytes=0
pidfile=/tmp/supervisord.pid
environment=PATH=/usr/share/logstash/bin:%(ENV_PATH)s

[rpcinterface:supervisor]
supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=http://127.0.0.1:9001

[program:logstash]
command=/usr/local/bin/logstash-start.sh
user=logstash
autostart=true
autorestart=true
startsecs=0
startretries=0
stopwaitsecs=60
stopasgroup=true
killasgroup=true
stopsignal=INT
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true
